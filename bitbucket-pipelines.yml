image: ubuntu:20.04

pipelines:
  default:
    - step:
        name: Install OS depencencies
        script:
          - apt update
          - apt install software-properties-common --yes
          - apt-add-repository --yes --update ppa:ansible/ansible
          - apt install ansible --yes
          - ansible-playbook --connection=local automation/ansible/dev_playbook.yaml

    - step:
        name: Install python dependencies
        caches:
          - pip
        script:
          - pip install -r requirements-pip-dev.txt

    - step:
        name: Test
        script:
          - pytest -v tests/* --junitxml=test-reports/report.xml
          
    - step:
        name: Release
        script:
          - python ./automation/new_release.py && python setup.py sdist bdist_wheel && twine upload --username="${TWINE_USERNAME}" --password="${TWINE_PASSWORD}" dist/*
